<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Checkout- Voltfood</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet" />
    <script src="assets/js/constant.js"></script>
    <!-- Add Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- =======================================================
  * Template Name: eNno
  * Template URL: https://bootstrapmade.com/enno-free-simple-bootstrap-template/
  * Updated: Aug 07 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  </head>

  <body class="index-page">
    <header id="header" class="header">
      <div class="container-fluid top-header">
        <div class="container-xl">
          <div class="row align-items-center">
            <div class="col-md-8 d-flex align-items-center">
              <nav id="navmenu" class="navmenu">
                <ul>
                  <li class="">
                    <img
                      src="assets/img/location-icon.png"
                      alt="Location Icon"
                      class="icon-right"
                    />
                    <span class="top-header-text"
                      >Address, Fox 99 Roving St, Big City PKU</span
                    >
                  </li>
                  <li class="">
                    <img
                      src="assets/img/email-icon.png"
                      alt="Email Icon"
                      class="icon-right"
                    />
                    <span class="top-header-text">hello@awesomesite.com</span>
                  </li>
                  <li class="">
                    <img
                      src="assets/img/phone-icon.png"
                      alt="Phone Icon"
                      class="icon-right"
                    />
                    <span class="top-header-text">+123-234-1234</span>
                  </li>
                </ul>
              </nav>
            </div>
            <div class="col-md-4 text-end">
              <a href="auth.html">Register</a>
              <a href="auth.html">Login</a>
              <a href="my-account.html">My Account</a>
            </div>
          </div>
        </div>
      </div>
      <div
        class="container-fluid container-xl position-relative d-flex align-items-center"
      >
        <a href="index.html" class="logo d-flex align-items-center me-auto">
          <img src="assets/img/logo.png" alt="Logo Image" />
        </a>

        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="index.html" class="active">HOMEPAGE</a></li>
            <li><a href="about.html">ABOUT US</a></li>
            <li><a href="menu.html">MENU</a></li>
            <li><a href="meal-packages.html">MEAL PACKAGES</a></li>
            <li><a href="wishlist.html">WISHLIST</a></li>
            <li><a href="cart.html">MY CART</a></li>
            <li><a href="privacy-and-policy.html">PRIVACY & POLICY</a></li>
            <li><a href="contact.html">CONTACT US</a></li>
            <!-- <li class="dropdown"><a href="#"><span>Dropdown</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="#">Dropdown 1</a></li>
              <li class="dropdown"><a href="#"><span>Deep Dropdown</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
                <ul>
                  <li><a href="#">Deep Dropdown 1</a></li>
                  <li><a href="#">Deep Dropdown 2</a></li>
                  <li><a href="#">Deep Dropdown 3</a></li>
                  <li><a href="#">Deep Dropdown 4</a></li>
                  <li><a href="#">Deep Dropdown 5</a></li>
                </ul>
              </li>
              <li><a href="#">Dropdown 2</a></li>
              <li><a href="#">Dropdown 3</a></li>
              <li><a href="#">Dropdown 4</a></li>
            </ul>
          </li> -->
          </ul>
          <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>

        <!-- <a class="btn-getstarted" href="index.html#about">Get Started</a> -->
      </div>
    </header>

    <main class="main">
      <!-- Checkout Section -->
      <section
        id="testimonials"
        class="testimonials section-inner light-background bg-image"
      >
        <a href="cart.html"><button class="btn btn-back">Back</button></a>
        <div class="container mt-4">
          <div class="coupon-section">
            <p>Have a coupon? Click here to enter your code</p>
          </div>

          <div class="checkout-container">
            <div class="row">
              <div class="col-md-7">
                <h5>Billing Details</h5>
                <form>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <input
                        type="text"
                        id="first-name"
                        class="form-control"
                        placeholder="First Name"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <input
                        type="text"
                        id="last-name"
                        class="form-control"
                        placeholder="Last Name"
                        required
                      />
                    </div>
                  </div>
                  <input
                    type="text"
                    id="company"
                    class="form-control mb-3"
                    placeholder="Company Name"
                  />
                  <input
                    type="text"
                    id="phone"
                    class="form-control mb-3"
                    placeholder="Phone Number"
                  />
                  <input
                    type="email"
                    id="email"
                    class="form-control mb-3"
                    placeholder="Email"
                    required
                  />

                  <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="saved-address">Choose Address</label>
                        <select id="saved-address" class="form-select" onchange="populateAddressFields()">
                            <option value="">Select an Address</option>
                            <!-- Addresses will be dynamically inserted here -->
                        </select>
                    </div>
                </div>
                
                <div id="address-fields" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select id="country" class="form-select" required>
                                <option value="">Select Country</option>
                                <option value="Saudi Arabia">Saudi Arabia</option>
                                <option value="Qatar">Qatar</option>
                                <option value="Egypt">Egypt</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select id="city" class="form-select" required>
                                <option value="">Select City</option>
                                <option value="Cairo">Cairo</option>
                                <option value="Riyadh">Riyadh</option>
                                <option value="Doha">Doha</option>
                            </select>
                        </div>
                    </div>
                
                   
                   
                    <input type="text" id="area" class="form-control mb-3" placeholder="Area"/>
                    <input type="text" id="state" class="form-control mb-3" placeholder="State"/>
                    <input type="text" id="street-address" class="form-control mb-3" placeholder="Street Address"/>
                </div>
                
                <button id="add-address-btn" class="btn btn-primary mt-3" style="display: none;" onclick="redirectToAddressPage()">
                    Add Address
                </button>
                </form>
              </div>

              <div class="col-md-5">
                <h5>Additional Information</h5>
                <textarea
                  class="form-control"
                  rows="4"
                  placeholder="Order Notes (Optional)"
                ></textarea>
              </div>
            </div>

            <div class="row">
              <h5 class="mt-4">Your Order</h5>
            </div>
            <div class="row">
              <table class="cart-table">
                <thead>
                  <tr>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="cart-table-body">
                  <!-- Cart items will be dynamically added here -->
                </tbody>
              </table>
            </div>
            <div class="row mt-4">
              <!-- Cart Totals Section -->
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <div class="cart-summary">
                  <h5>Cart Totals</h5>
                  <table class="table">
                    <tr>
                      <td>Subtotal</td>
                      <td id="subtotal-amount">0.00 SR</td>
                    </tr>
                    <tr>
                      <td><strong>Order Total</strong></td>
                      <td><strong id="order-total-amount">0.00 SR</strong></td>
                    </tr>
                  </table>

                  <button id="order-submit" class="btn proceed-btn w-100">
                    Proceed
                  </button>
                </div>
              </div>
            </div>
            <div class="row mt-4">
              <form
                id="payment-form"
                action="https://voltfood.co/payment-success.html"
                class="paymentWidgets"
                data-brands="VISA MASTER MADA"
              ></form>
            </div>
          </div>
        </div>
      </section>
      <!-- /Checkout Section -->
      <!-- Toast Container -->
      <div id="toast-container" class="toast-container"></div>
    </main>

    <script>
      const paymentApiUrl = `${apiBaseUrl}payment/ready`; // Construct the full API endpoint

      document
        .getElementById("order-submit")
        .addEventListener("click", async function () {
          try {
            // ‚úÖ Get the token when needed
            const token = localStorage.getItem("accessToken");
            if (!token) {
              console.error("‚ùå No access token found!");
              return;
            }

            // ‚úÖ Get amount dynamically from the order total element
            const orderTotalElement =
              document.getElementById("order-total-amount");
            const orderTotalText = orderTotalElement.innerText.trim(); // Example: "92.00 SR"
            const orderTotalAmount = parseFloat(
              orderTotalText.replace(" SR", "")
            ); // Extract numeric value

            console.log(`üí∞ Extracted Order Amount: ${orderTotalAmount} SAR`);

            // ‚úÖ Send dynamic amount in API request
            const response = await fetch(paymentApiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                amount: orderTotalAmount.toFixed(2), // Ensure correct format like "92.00"
                currency: "SAR",
              }),
            });

            const result = await response.json();

            if (
              result.status === 200 &&
              result.data?.id &&
              result.data?.integrity
            ) {
              console.log("‚úÖ Checkout ID:", result.data.id);
              initializeHyperPay(result.data.id, result.data.integrity);
            } else {
              console.error(
                "‚ùå Payment request failed:",
                result.message || "Unknown error"
              );
            }
          } catch (error) {
            console.error("üî• Error:", error);
          }
        });

      function initializeHyperPay(checkoutId, integrity) {
        const script = document.createElement("script");
        script.src = `https://eu-test.oppwa.com/v1/paymentWidgets.js?checkoutId=${checkoutId}`;
        script.integrity = integrity;
        script.crossOrigin = "anonymous";
        document.body.appendChild(script);
      }
    </script>

    <script>
      const CartApiUrl = `${apiBaseUrl}cart`;
      const token = localStorage.getItem("accessToken");

      // Function to fetch and display the cart items and calculate total price
      async function fetchCart() {
        if (!token) {
          console.error("Access token not found!");
          return;
        }

        try {
          const response = await fetch(CartApiUrl, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.status === 200 && result.data.cart.length > 0) {
            const cartTableBody = document.querySelector(".cart-table tbody");
            cartTableBody.innerHTML = ""; // Clear previous content

            let totalCartPrice = 0; // Store total price

            result.data.cart.forEach((cartItem) => {
              const product = cartItem.product;
              const itemTotal = parseFloat(product.price) * cartItem.quantity;
              totalCartPrice += itemTotal; // Add to total price

              const row = document.createElement("tr");
              row.setAttribute("data-product-id", product.id); // Store product_id in row

              row.innerHTML = `
                        <td> <img src="${imgBaseUrl}${
                product.productImage
              }" alt="${product.title}"  style=""></td>
                        <td>${product.name}</td>
                        <td>${product.price} SR</td>
                        <td>
                            <div class="quantity-control">
                                <input type="text" value="${
                                  cartItem.quantity
                                }" data-id="${cartItem.id}" readonly>
                            </div>
                        </td>
                        <td class="item-total">${itemTotal.toFixed(2)} SR</td>
                    `;

              cartTableBody.appendChild(row);
            });

            // Update cart totals
            updateCartTotal(totalCartPrice);
          } else {
            document.querySelector(".cart-table tbody").innerHTML =
              "<tr><td colspan='6'>Your cart is empty.</td></tr>";
            updateCartTotal(0);
          }
        } catch (error) {
          console.error("Error fetching cart:", error);
          document.querySelector(".cart-table tbody").innerHTML =
            "<tr><td colspan='6'>Failed to load cart.</td></tr>";
          updateCartTotal(0);
        }
      }

      // Function to update Subtotal and Order Total
      function updateCartTotal(totalPrice) {
        document.getElementById(
          "subtotal-amount"
        ).innerText = `${totalPrice.toFixed(2)}SR`;
        document.getElementById(
          "order-total-amount"
        ).innerText = `${totalPrice.toFixed(2)}SR`;
      }

      // Event delegation for quantity updates and removal
      document
        .querySelector(".cart-table tbody")
        .addEventListener("click", function (event) {
          if (event.target.classList.contains("increase")) {
            const cartItemId = event.target.getAttribute("data-id");
            updateCartItem(cartItemId, "increase");
          }

          if (event.target.classList.contains("decrease")) {
            const cartItemId = event.target.getAttribute("data-id");
            updateCartItem(cartItemId, "decrease");
          }

          if (event.target.classList.contains("remove-btn")) {
            const cartItemId = event.target.getAttribute("data-id");
            const productId = event.target
              .closest("tr")
              .getAttribute("data-product-id"); // Get product_id from row
            removeCartItem(cartItemId, productId);
          }
        });

      // Function to remove item from cart
      async function removeCartItem(cartItemId, productId) {
        if (!token) {
          console.error("Access token not found!");
          return;
        }

        if (!productId) {
          console.error("Product ID not found!");
          return;
        }

        try {
          const response = await fetch(`${apiUrl}/remove`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              product_id: productId, // Correct API body format
            }),
          });

          const result = await response.json();

          if (response.ok) {
            fetchCart(); // Refresh cart after removal
          } else {
            alert(
              `Failed to remove item: ${result.message || "Unknown error"}`
            );
          }
        } catch (error) {
          console.error("Error removing cart item:", error);
          alert("An error occurred while removing the item from the cart.");
        }
      }

      // Load the cart when the page loads
      document.addEventListener("DOMContentLoaded", fetchCart);
    </script>

    <!-- /Subscribe Footer Section -->
    <!-- Footer will be loaded here -->
    <div id="footer-placeholder"></div>

    <script>
      // Load footer.html into the placeholder div
      fetch("footer.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("footer-placeholder").innerHTML = data;
        })
        .catch((error) => console.error("Error loading footer:", error));
    </script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
      fetchSavedAddresses();
  });

  const apiUrl = `${apiBaseUrl}address`;

  function fetchSavedAddresses() {
      const token = localStorage.getItem("accessToken");
      if (!token) {
          showToast('You need to login first.', 'error');
          setTimeout(() => { window.location.href = 'auth.html'; }, 2000);
          return;
      }

      axios.get(apiUrl, {
          headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }
      })
      .then(response => {
          const addresses = response.data.data?.addresses || [];
          populateAddressDropdown(addresses);
      })
      .catch(error => {
          console.error("Error fetching addresses:", error);
          showToast("Failed to load addresses. Please try again.", "error");
      });
  }

  function populateAddressDropdown(addresses) {
      const addressDropdown = document.getElementById('saved-address');
      addressDropdown.innerHTML = '<option value="">Select an Address</option>';

      if (addresses.length === 0) {
          document.getElementById('add-address-btn').style.display = 'block'; // Show "Add Address" button
          return;
      }

      addresses.forEach(address => {
          const option = document.createElement('option');
          option.value = JSON.stringify(address); // Store address details in value
          option.textContent = address.type; // Show "Home" or "Office"
          addressDropdown.appendChild(option);
      });
  }

  function populateAddressFields() {
      const selectedAddress = document.getElementById('saved-address').value;
      if (!selectedAddress) {
          document.getElementById('address-fields').style.display = 'none';
          return;
      }

      const address = JSON.parse(selectedAddress);
      document.getElementById('street-address').value = address.street || "";
      document.getElementById('state').value = address.block || "";
      document.getElementById('area').value = address.area || "";
      document.getElementById('zip-code').value = address.flat || "";
      document.getElementById('address-fields').style.display = 'block';
  }

  function redirectToAddressPage() {
      window.location.href = 'my-account.html'; // Redirect to address page
  }
</script>

    <!-- Scroll Top -->
    <a
      href="#"
      id="scroll-top"
      class="scroll-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <!-- Preloader -->
    <div id="preloader"></div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script>
      fetch("footer.html")
        .then((response) => response.text())
        .then(
          (data) =>
            (document.getElementById("footer-placeholder").innerHTML = data)
        )
        .catch((error) => console.error("Error loading the footer:", error));
    </script>

    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document
          .querySelectorAll(".quantity-control button")
          .forEach((button) => {
            button.addEventListener("click", function () {
              let input = this.parentElement.querySelector("input");
              let value = parseInt(input.value);
              if (this.classList.contains("increase")) {
                input.value = value + 1;
              } else if (this.classList.contains("decrease") && value > 1) {
                input.value = value - 1;
              }
            });
          });

        document.querySelectorAll(".remove-btn").forEach((button) => {
          button.addEventListener("click", function () {
            this.closest("tr").remove();
          });
        });
      });
    </script>
    <script>
      var wpwlOptions = {
        paymentTarget: "_top",
        style: "card",
      };
    </script>
  </body>
</html>
